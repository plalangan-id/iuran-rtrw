<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PLALANGAN.NET - FINAL BERSID</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0f1115; color: #ffffff; }
        .stat-box { background: linear-gradient(145deg, #1a1d24, #14161b); border-radius: 24px; padding: 20px; text-align: center; }
        .input-premium { background: #252932; border-radius: 18px; padding: 18px; width: 100%; color: white; outline: none; margin-bottom: 12px; font-weight: 700; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(10, 12, 16, 0.98); backdrop-filter: blur(25px); display: none; flex-direction: column; z-index: 1000; padding: 20px; }
        .modal-content-scroll { width: 100%; max-width: 600px; margin: 0 auto; flex-grow: 1; overflow-y: auto; padding-bottom: 100px; }
        .btn-back { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #ef4444; color: white; padding: 16px 50px; border-radius: 50px; font-weight: 800; z-index: 1100; text-transform: uppercase; }
        .icon-menu { @apply flex flex-col items-center justify-center; background: transparent; border: none; }
        .icon-menu span { font-size: 45px; margin-bottom: 8px; }
        .icon-menu p { font-size: 9px; font-weight: 800; color: #64748b; }
        .hidden-el { display: none; }
        table { width: 100%; }
        td { padding: 15px 8px; border-bottom: 1px solid rgba(255,255,255,0.03); }
    </style>
</head>
<body class="p-6">

    <div id="login-page" class="fixed inset-0 bg-[#0f1115] z-[2000] flex flex-col justify-center items-center p-8">
        <h1 class="text-3xl font-black mb-2 uppercase">Admin Login</h1>
        <p class="text-[10px] font-bold text-gray-500 tracking-[0.3em] mb-10">PLALANGAN.NET</p>
        <div class="w-full max-w-xs">
            <input type="text" id="user" placeholder="USERNAME" class="input-premium text-center">
            <input type="password" id="pass" placeholder="PASSWORD" class="input-premium text-center">
            <button onclick="login()" class="w-full bg-white text-black p-5 rounded-2xl font-black mt-4 uppercase">Masuk</button>
        </div>
    </div>

    <div id="main-app" class="hidden-el">
        <div class="text-center mb-8 mt-4">
            <h1 class="text-4xl font-black uppercase">PLALANGAN.NET</h1>
            <p class="text-[10px] font-bold text-gray-500 uppercase tracking-[0.4em]">Dashboard Admin</p>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-10">
            <div class="stat-box"><p class="text-[9px] font-bold text-red-500 uppercase">BELUM BAYAR</p><h2 id="stat-belum" class="text-3xl font-black text-red-500">0</h2></div>
            <div class="stat-box"><p class="text-[9px] font-bold text-green-500 uppercase">TOTAL MASUK</p><h2 id="stat-uang" class="text-2xl font-black text-green-400">Rp 0</h2></div>
        </div>

        <div class="grid grid-cols-3 gap-y-10 mb-10">
            <button onclick="openM('tagihan', 'all')" class="icon-menu"><span>üßæ</span><p>TAGIHAN</p></button>
            <button onclick="openM('tagihan', 'belum')" class="icon-menu"><span>‚è≥</span><p>BELUM</p></button>
            <button onclick="openM('tagihan', 'lunas')" class="icon-menu"><span>‚úÖ</span><p>LUNAS</p></button>
            <button onclick="openM('master')" class="icon-menu"><span>üë•</span><p>MEMBER</p></button>
            <button onclick="openM('tambah')" class="icon-menu"><span>‚ûï</span><p>BARU</p></button>
            <button onclick="openM('keluar')" class="icon-menu"><span>üí∏</span><p>PENGELUARAN</p></button>
            <button onclick="logout()" class="icon-menu"><span>üö™</span><p>LOGOUT</p></button>
        </div>
    </div>

    <div id="modal-container" class="modal-overlay">
        <div class="modal-content-scroll">
            <div id="m-list" class="hidden-el"><h3 id="modal-title" class="text-2xl font-black mb-8 uppercase text-center">Daftar</h3><div id="list-render"></div></div>
            
            <div id="m-keluar" class="hidden-el pt-6">
                <h3 class="text-2xl font-black mb-6 uppercase text-center">Catat Pengeluaran</h3>
                <div class="bg-[#1a1d24] p-6 rounded-[28px] mb-8">
                    <input type="text" id="exp-nama" placeholder="NAMA BARANG" class="input-premium uppercase">
                    <input type="number" id="exp-jumlah" placeholder="JUMLAH (RP)" class="input-premium">
                    <input type="date" id="exp-tgl" class="input-premium">
                    <button onclick="simpanPengeluaran()" class="w-full bg-orange-600 p-5 rounded-2xl font-black">SIMPAN</button>
                </div>
                <div id="tabel-keluar-render"></div>
            </div>

            <div id="m-tambah" class="hidden-el pt-6">
                <h3 class="text-2xl font-black mb-8 uppercase text-center">Member Baru</h3>
                <input type="text" id="new-nama" placeholder="NAMA LENGKAP" class="input-premium uppercase">
                <input type="number" id="new-nominal" placeholder="NOMINAL" class="input-premium">
                <input type="number" id="new-aktivasi" placeholder="TGL TAGIHAN" class="input-premium">
                <button onclick="tambahPelanggan()" class="w-full bg-blue-600 p-5 rounded-2xl font-black">SIMPAN</button>
            </div>
        </div>
        <button onclick="closeM()" class="btn-back">KEMBALI</button>
    </div>

<script>
    // GANTI DENGAN URL DEPLOY ANDA
    const API_URL = "https://script.google.com/macros/s/AKfycbxlKNSqgSPu43AGlBPKfuxf8JwFbyXx9-Nr8Ht-WF1KS9-kOS2Wu2jokmCt5xx13-BGVg/exec";
    
    let dataTagihan = [], dataMaster = [], dataKeluar = [];

    window.onload = function() { if (localStorage.getItem('plalangan_isLoggedIn') === 'true') tampilkanDashboard(); };

    function login() {
        const u = document.getElementById('user').value.trim().toLowerCase();
        const p = document.getElementById('pass').value.trim();
        if(u === "admin" && p === "1234") { localStorage.setItem('plalangan_isLoggedIn', 'true'); tampilkanDashboard(); }
        else { alert("Salah!"); }
    }

    function tampilkanDashboard() { 
        document.getElementById('login-page').style.display = 'none'; 
        document.getElementById('main-app').classList.remove('hidden-el'); 
        load(); 
    }

    function logout() { localStorage.removeItem('plalangan_isLoggedIn'); location.reload(); }

    async function load() {
        try {
            const res = await fetch(`${API_URL}?action=read`);
            const json = await res.json();
            dataTagihan = json.tagihan || []; 
            dataMaster = json.master || []; 
            dataKeluar = json.pengeluaran || [];
            updateStats();
        } catch(e) { console.error(e); }
    }

    function updateStats() {
        const belum = dataTagihan.filter(d => String(d.lunas).toLowerCase() == "false").length;
        const uang = dataTagihan.filter(d => String(d.lunas).toLowerCase() == "true").reduce((s, i) => s + Number(i.jumlah), 0);
        document.getElementById('stat-belum').innerText = belum;
        document.getElementById('stat-uang').innerText = "Rp " + uang.toLocaleString('id-ID');
    }

    function openM(type, filter = 'all') {
        document.getElementById('modal-container').style.display = 'flex';
        ['m-list', 'm-tambah', 'm-keluar'].forEach(id => document.getElementById(id).classList.add('hidden-el'));
        if(type === 'tagihan' || type === 'master') { 
            document.getElementById('m-list').classList.remove('hidden-el'); 
            renderToModal(type, filter); 
        }
        else if(type === 'keluar') { 
            document.getElementById('m-keluar').classList.remove('hidden-el'); 
            renderTabelKeluar(); 
        }
        else { document.getElementById('m-' + type).classList.remove('hidden-el'); }
    }

    function renderToModal(type, filter) {
        const container = document.getElementById('list-render'); container.innerHTML = "";
        let source = (type === 'tagihan') ? dataTagihan : dataMaster;
        
        if (type === 'tagihan') {
            if (filter === 'belum') source = source.filter(d => String(d.lunas).toLowerCase() == "false");
            if (filter === 'lunas') source = source.filter(d => String(d.lunas).toLowerCase() == "true");
        }

        let html = `<table><tbody>`;
        source.forEach(h => {
            const isLunas = String(h.lunas).toLowerCase() == "true";
            // PROTEKSI NAN:
            const val = Number(h.jumlah || h.nominal || 0);
            
            html += `<tr onclick="if(!${isLunas} && '${type}'=='tagihan') bayar('${h.id}')">
                <td>
                    <p class="text-xs font-black uppercase text-white">${h.nama || 'TANPA NAMA'}</p>
                    <p class="text-[10px] text-blue-400 font-bold">Rp${val.toLocaleString('id-ID')}</p>
                </td>
                <td class="text-right">
                    <span class="px-2 py-1 rounded text-[8px] font-black uppercase ${isLunas ? 'bg-green-500/20 text-green-500' : 'bg-red-600 text-white'}">
                        ${isLunas ? 'Lunas' : 'Bayar'}
                    </span>
                </td>
            </tr>`;
        });
        container.innerHTML = html + `</tbody></table>`;
    }

    function renderTabelKeluar() {
        const container = document.getElementById('tabel-keluar-render');
        let total = 0, html = `<table><tbody>`;
        dataKeluar.forEach(item => {
            total += Number(item.jumlah);
            html += `<tr><td><p class="text-xs font-bold uppercase text-white">${item.keterangan}</p><p class="text-[8px] text-gray-500">${item.tanggal}</p></td><td class="text-right text-red-400 font-bold text-xs">-Rp${Number(item.jumlah).toLocaleString()}</td></tr>`;
        });
        container.innerHTML = html + `</tbody></table><div class="mt-4 p-4 bg-red-500/10 rounded-xl text-right font-black text-red-500 uppercase">Total: Rp${total.toLocaleString()}</div>`;
    }

    async function simpanPengeluaran() {
        const k = document.getElementById('exp-nama').value;
        const j = document.getElementById('exp-jumlah').value;
        const t = document.getElementById('exp-tgl').value;
        if(!k || !j || !t) return alert("Isi semua!");
        await fetch(`${API_URL}?action=tambah_pengeluaran&ket=${encodeURIComponent(k)}&jml=${j}&tgl=${t}`);
        alert("Berhasil!"); closeM(); load();
    }

    async function bayar(id) { if(confirm("Lunas?")) { await fetch(`${API_URL}?action=update&id=${id}`); await load(); closeM(); } }
    function closeM() { document.getElementById('modal-container').style.display = 'none'; }

    async function tambahPelanggan() {
        const n = document.getElementById('new-nama').value;
        const m = document.getElementById('new-nominal').value;
        const a = document.getElementById('new-aktivasi').value;
        await fetch(`${API_URL}?action=tambah_warga&nama=${encodeURIComponent(n)}&nominal=${m}&aktivasi=${a}`);
        alert("Berhasil!"); closeM(); load();
    }
</script>
</body>
</html>
