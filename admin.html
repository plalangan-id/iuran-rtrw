<script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzOSes2cOdZKV7aq6Fp0XJ8ZdbwTtdzqCd40KxNuEQPLTlCY4hPYEPiOjf5bEEpIRZ-Ag/exec";
        let dataTagihan = [], dataMaster = [], currentTab = 'tagihan', filterMode = 'all';

        function toggleTabel() {
            const w = document.getElementById('wrapper-tabel'), icon = document.getElementById('ic-min');
            if (w.classList.contains('hidden-table')) { w.classList.remove('hidden-table'); icon.innerText = "ðŸ‘ï¸"; } 
            else { w.classList.add('hidden-table'); icon.innerText = "ðŸ”’"; }
        }

        function setFilter(mode) {
            filterMode = (filterMode === mode) ? 'all' : mode;
            document.getElementById('f-belum').classList.toggle('filter-active', filterMode === 'belum');
            document.getElementById('f-lunas').classList.toggle('filter-active', filterMode === 'lunas');
            render();
            if(filterMode !== 'all' && document.getElementById('wrapper-tabel').classList.contains('hidden-table')) toggleTabel();
        }

        function togglePanel(nama) {
            ['tambah', 'gen', 'rekap', 'info'].forEach(p => {
                const el = document.getElementById('panel-' + p);
                (p === nama) ? el.classList.toggle('hidden') : el.classList.add('hidden');
            });
            if(nama === 'rekap') hitungRekap();
        }

        function hitungRekap() {
            const list = document.getElementById('list-rekap');
            list.innerHTML = "";
            let rekapBulan = {};
            dataTagihan.filter(d => String(d.lunas).toLowerCase() == "true").forEach(d => {
                rekapBulan[d.bulan] = (rekapBulan[d.bulan] || 0) + Number(d.jumlah);
            });
            const urutanBulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            urutanBulan.forEach(bln => {
                if(rekapBulan[bln]) {
                    list.innerHTML += `<div class="flex justify-between items-center bg-white/5 p-3 rounded-xl border border-white/5 mb-2"><span class="text-[10px] font-black uppercase text-gray-400">${bln}</span><span class="text-[10px] font-black text-green-500">Rp ${rekapBulan[bln].toLocaleString('id-ID')}</span></div>`;
                }
            });
        }

        async function load() {
            try {
                const res = await fetch(`${API_URL}?action=read`);
                const json = await res.json();
                dataTagihan = json.tagihan || []; dataMaster = json.master || [];
                document.getElementById('papan-tulis').value = localStorage.getItem('plalangan_note') || "";
                updateStats(); render();
            } catch(e) { console.log(e); }
        }

        function updateStats() {
            const belum = dataTagihan.filter(d => String(d.lunas).toLowerCase() == "false").length;
            const uang = dataTagihan.filter(d => String(d.lunas).toLowerCase() == "true").reduce((s, i) => s + Number(i.jumlah), 0);
            document.getElementById('stat-belum').innerText = belum;
            document.getElementById('stat-uang').innerText = "Rp " + uang.toLocaleString('id-ID');
        }

        function render() {
            const head = document.getElementById('head-tabel'), body = document.getElementById('body-tabel'), cari = document.getElementById('cari').value.toUpperCase();
            body.innerHTML = "";

            if (currentTab === 'tagihan') {
                head.innerHTML = `<th class="col-nama">Nama</th><th class="col-akt">Akt</th><th class="col-rp">Rp</th><th class="col-aksi">Aksi</th>`;
                let filtered = dataTagihan.filter(d => d.nama.toUpperCase().includes(cari));
                if (filterMode === 'belum') filtered = filtered.filter(d => String(d.lunas).toLowerCase() == "false");
                if (filterMode === 'lunas') filtered = filtered.filter(d => String(d.lunas).toLowerCase() == "true");
                
                filtered.forEach(h => {
                    const lunas = String(h.lunas).toLowerCase() == "true";
                    body.innerHTML += `<tr class="animate-pop ${lunas ? 'baris-lunas' : 'baris-belum'}">
                        <td class="font-bold uppercase text-[9px] truncate">${h.nama} ${!lunas ? 'ðŸ“Œ' : ''}</td>
                        <td class="text-center">${h.aktivasi || '0'}</td>
                        <td class="${lunas ? 'text-green-500' : 'text-red-500'} font-bold">Rp${Number(h.jumlah).toLocaleString()}</td>
                        <td><button onclick="bayar('${h.nama}', '${h.bulan}')" class="w-full py-1 rounded text-[7px] font-black transition-all active:scale-75 ${lunas ? 'bg-green-500/10 text-green-500 border border-green-500' : 'bg-red-500 text-white shadow-lg'}">${lunas ? 'LUNAS' : 'BAYAR'}</button></td>
                    </tr>`;
                });
            } else {
                head.innerHTML = `<th class="col-nama">Nama</th><th class="col-akt">Akt</th><th class="col-rp">Nominal</th><th class="col-aksi">Aksi</th>`;
                dataMaster.filter(d => d.nama.toUpperCase().includes(cari)).forEach(h => {
                    body.innerHTML += `<tr class="animate-pop baris-lunas">
                        <td class="font-bold uppercase text-[9px] truncate">${h.nama}</td>
                        <td class="text-center">${h.aktivasi || '0'}</td>
                        <td class="text-gray-400 font-bold">Rp${Number(h.nominal).toLocaleString()}</td>
                        <td><button onclick="genSingle('${h.nama}', '${h.aktivasi}', '${h.nominal}')" class="w-full bg-blue-500 text-white py-1 rounded text-[7px] font-black uppercase active:scale-75 transition-all shadow-md">Gen</button></td>
                    </tr>`;
                });
            }
        }

        // --- FUNGSI GEN SINGLE YANG DIPERBAIKI ---
        async function genSingle(nama, aktivasi, nominal) {
            const bln = document.getElementById('bln-gen').value;
            const thn = document.getElementById('thn-gen').value;
            
            if(confirm(`Buat tagihan untuk ${nama} bulan ${bln}?`)) {
                const res = await fetch(`${API_URL}?action=generateIndividu&nama=${encodeURIComponent(nama)}&aktivasi=${aktivasi}&nominal=${nominal}&bulan=${bln}&tahun=${thn}`);
                const txt = await res.text();
                if(txt === "Double") {
                    alert("Gagal: Tagihan untuk " + nama + " di bulan " + bln + " sudah ada!");
                } else {
                    alert("Berhasil membuat tagihan untuk " + nama);
                    switchTab('tagihan');
                    load();
                }
            }
        }

        async function bayar(nama, bulan) { 
            if(confirm("Konfirmasi Bayar?")) { 
                await fetch(`${API_URL}?action=update&nama=${encodeURIComponent(nama)}&bulan=${bulan}`); 
                load(); 
            } 
        }

        async function tambahPelanggan() { 
            const n = document.getElementById('new-nama').value, m = document.getElementById('new-nominal').value, a = document.getElementById('new-aktivasi').value;
            if(!n || !m) return alert("Isi Nama & Nominal!");
            await fetch(`${API_URL}?action=tambah_warga&nama=${encodeURIComponent(n)}&nominal=${m}&aktivasi=${a}`);
            alert("Berhasil!"); togglePanel(''); load();
        }

        async function prosesGenerate() {
            const b = document.getElementById('bln-gen').value, t = document.getElementById('thn-gen').value;
            if(confirm(`Generate massal bulan ${b} ${t}?`)) { 
                await fetch(`${API_URL}?action=generate&bulan=${b}&tahun=${t}`); 
                alert("Selesai!"); 
                load(); 
            }
        }

        function switchTab(t) { currentTab = t; document.getElementById('btn-tab-tagihan').classList.toggle('tab-active', t=='tagihan'); document.getElementById('btn-tab-master').classList.toggle('tab-active', t=='master'); render(); }
        
        function autoSavePapan() {
            const teks = document.getElementById('papan-tulis').value;
            localStorage.setItem('plalangan_note', teks);
            document.getElementById('save-status').innerText = "MENYIMPAN...";
            clearTimeout(window.sv);
            window.sv = setTimeout(() => { document.getElementById('save-status').innerText = "TERSIMPAN"; }, 800);
        }
        window.onload = load;
    </script>
